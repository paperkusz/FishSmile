<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>üåø GreenSync Duel ‚Äî AI Daily (Gemini) Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Noto+Sans+Thai:wght@400;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
<style>
  :root{
    --bg:#f5f7fa;--text:#1f2430;--muted:#667085;--card:#fff;--border:#e5e7eb;
    --primary:#10b981;--primary-light:#d1fae5;--primary-dark:#047857;
    --secondary:#8b5cf6;--accent:#f59e0b;--shadow:0 6px 18px rgba(0,0,0,.06);
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,"Noto Sans Thai",system-ui}
  .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);margin-bottom:16px}
  .hd{padding:14px 16px;border-bottom:1px solid var(--border);font-weight:600;background:var(--primary-light);color:var(--primary-dark)}
  .bd{padding:14px 16px}
  .h1{font-weight:700;font-size:28px}
  .muted{color:var(--muted)}
  .flex{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  .btn{display:inline-flex;gap:8px;align-items:center;border-radius:999px;padding:10px 16px;border:1px solid var(--primary);background:var(--primary);color:#fff;cursor:pointer;font-weight:600}
  .btn.ghost{background:#fff;color:var(--primary-dark)}
  .btn.danger{background:#ef4444;border-color:#ef4444}
  label{display:block;margin-bottom:6px;font-size:14px}
  input,select{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  @media(max-width:900px){.row{grid-template-columns:1fr}.grid2{grid-template-columns:1fr}}
  .kpi{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:8px}
  .kpi .it{background:#f8fafc;border:1px solid var(--border);border-radius:12px;padding:8px 10px}
  .kpi .v{font-weight:700}
  .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;background:var(--primary-light);color:var(--primary-dark);font-weight:600;font-size:12px}
  .hearts{font-size:24px;line-height:1.1;color:#e91e63;word-break:break-word}
  .teamBadge{display:flex;align-items:center;gap:8px}
  .table-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch}
  table{width:100%;border-collapse:collapse;min-width:520px}
  th,td{padding:6px 8px;border-bottom:1px solid var(--border);font-size:13px}
  thead th{background:#f8fafc}
  .chips{display:flex;gap:8px;flex-wrap:wrap}
  .chip{padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:#fff;font-size:12px}
  .dot{width:10px;height:10px;border-radius:999px;background:#9ca3af;display:inline-block}
  .dot.ok{background:#10b981}.dot.fail{background:#ef4444}.dot.load{background:#f59e0b}
  @media (max-width:480px){
    .h1{font-size:22px}
    .btn{padding:8px 12px;font-size:14px}
    .hearts{font-size:20px}
  }
</style>
</head>
<body>
<div class="wrap">
  <!-- Header -->
  <div class="card">
    <div class="bd flex" style="justify-content:space-between">
      <div class="flex">
        <div class="h1">üåø GreenSync ‚Äî Duel Mode (AI Daily)</div>
        <span class="badge"><i class="fa-solid fa-clock"></i> <span id="nowTH">‚Äî</span></span>
      </div>
      <div class="flex">
        <button class="btn ghost" id="btnTest"><i class="fa-solid fa-plug"></i> ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</button>
        <button class="btn danger ghost" id="btnReset"><i class="fa-solid fa-rotate-left"></i> ‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
      </div>
    </div>
  </div>

  <!-- Form -->
  <div class="card" id="secForm">
    <div class="hd">‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå & ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</div>
    <div class="bd">
      <div class="row">
        <div>
          <label>Web App URL (‡∏Ç‡∏≠‡∏á GAS)</label>
          <input id="webapp" placeholder="https://script.google.com/macros/s/DEPLOYMENT_ID/exec">
        </div>
        <div>
          <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ñ‡∏ß (limit)</label>
          <select id="limit"><option>10</option><option>30</option><option selected>50</option><option>100</option></select>
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <div>
          <label>‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡∏° A</label>
          <input id="teamNameA" value="‡∏ó‡∏µ‡∏° A">
        </div>
        <div>
          <label>‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡∏° B</label>
          <input id="teamNameB" value="‡∏ó‡∏µ‡∏° B">
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <div>
          <label>‡∏£‡∏≠‡∏ö‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï (‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)</label>
          <select id="interval"><option>10</option><option selected>20</option><option>30</option><option>60</option></select>
        </div>
        <div>
          <label>‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏î‡∏™‡∏≠‡∏ö (‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ß‡πá‡∏ö‡πÅ‡∏≠‡∏õ)</label>
          <select id="demo"><option value="off" selected>‡∏õ‡∏¥‡∏î</option><option value="on">‡πÄ‡∏õ‡∏¥‡∏î</option></select>
        </div>
      </div>
      <div class="flex" style="margin-top:12px">
        <button class="btn" id="btnStart"><i class="fa-solid fa-play"></i> ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô ‚ûú ‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</button>
        <span class="muted" id="status"><span class="dot" id="dot"></span> <span id="statusText"></span></span>
      </div>
    </div>
  </div>

  <!-- Dashboard -->
  <div class="card" id="secDash" style="display:none">
    <div class="hd">‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î 2 ‡∏Å‡∏£‡∏∞‡∏ñ‡∏≤‡∏á (<span id="teamALabel">‡∏ó‡∏µ‡∏° A</span> vs <span id="teamBLabel">‡∏ó‡∏µ‡∏° B</span>)</div>
    <div class="bd grid2">
      <!-- Team A -->
      <div>
        <div class="flex" style="justify-content:space-between">
          <div class="teamBadge"><i class="fa-solid fa-leaf" style="color:#10b981"></i> <strong id="teamANameDisplay">‡∏ó‡∏µ‡∏° A</strong></div>
          <div class="badge"><i class="fa-solid fa-database"></i> <span id="dsA">‚Äî</span></div>
        </div>
        <div class="kpi" style="margin-top:8px">
          <div class="it"><div>Temp (¬∞C)</div><div class="v" id="a_temp">-</div></div>
          <div class="it"><div>Humid (%)</div><div class="v" id="a_hum">-</div></div>
          <div class="it"><div>Soil (%)</div><div class="v" id="a_soil">-</div></div>
          <div class="it"><div>Light (%)</div><div class="v" id="a_light">-</div></div>
        </div>
        <div style="margin-top:8px">‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (AI):</div>
        <div class="hearts" id="a_hearts">‚Äî</div>
        <div class="muted" id="a_advice" style="margin-top:6px">‚Äî</div>
        <div class="table-wrap" style="margin-top:8px">
          <table>
            <thead><tr><th style="text-align:left">‡πÄ‡∏ß‡∏•‡∏≤</th><th>Temp</th><th>RH</th><th>Soil</th><th>Light</th></tr></thead>
            <tbody id="a_tbl"></tbody>
          </table>
        </div>
      </div>
      <!-- Team B -->
      <div>
        <div class="flex" style="justify-content:space-between">
          <div class="teamBadge"><i class="fa-solid fa-seedling" style="color:#8b5cf6"></i> <strong id="teamBNameDisplay">‡∏ó‡∏µ‡∏° B</strong></div>
          <div class="badge"><i class="fa-solid fa-database"></i> <span id="dsB">‚Äî</span></div>
        </div>
        <div class="kpi" style="margin-top:8px">
          <div class="it"><div>Temp (¬∞C)</div><div class="v" id="b_temp">-</div></div>
          <div class="it"><div>Humid (%)</div><div class="v" id="b_hum">-</div></div>
          <div class="it"><div>Soil (%)</div><div class="v" id="b_soil">-</div></div>
          <div class="it"><div>Light (%)</div><div class="v" id="b_light">-</div></div>
        </div>
        <div style="margin-top:8px">‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (AI):</div>
        <div class="hearts" id="b_hearts">‚Äî</div>
        <div class="muted" id="b_advice" style="margin-top:6px">‚Äî</div>
        <div class="table-wrap" style="margin-top:8px">
          <table>
            <thead><tr><th style="text-align:left">‡πÄ‡∏ß‡∏•‡∏≤</th><th>Temp</th><th>RH</th><th>Soil</th><th>Light</th></tr></thead>
            <tbody id="b_tbl"></tbody>
          </table>
        </div>
      </div>
    </div>
    <div class="bd flex">
      <button class="btn" id="btnGoInsights"><i class="fa-solid fa-heart-pulse"></i> ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏∂‡∏Å</button>
      <button class="btn ghost" id="btnRefresh"><i class="fa-solid fa-rotate"></i> ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</button>
      <button class="btn" id="btnAnalyzeToday"><i class="fa-solid fa-wand-magic-sparkles"></i> ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏î‡πâ‡∏ß‡∏¢ AI</button>
    </div>
  </div>

  <!-- Insights -->
  <div class="card" id="secInsights" style="display:none">
    <div class="hd">‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏∂‡∏Å (AI ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô)</div>
    <div class="bd">
      <div class="chips">
        <span class="chip">‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: ‡∏ä‡∏µ‡∏ï AI_PlantDaily_A/B</span>
        <span class="chip">‡∏Å‡∏î ‚Äú‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏î‡πâ‡∏ß‡∏¢ AI‚Äù ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</span>
      </div>
      <div style="margin:12px 0">
        <canvas id="chartHearts" height="120"></canvas>
      </div>
      <div class="grid2" style="margin-top:12px">
        <div>
          <div class="h1" style="font-size:18px;margin-bottom:6px">‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</div>
          <div id="dailyTable" class="table-wrap sub">‚Äî</div>
        </div>
        <div>
          <div class="h1" style="font-size:18px;margin-bottom:6px">‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</div>
          <div id="weeklyTable" class="table-wrap sub">‚Äî</div>
        </div>
      </div>
      <div class="flex" style="margin-top:12px">
        <button class="btn ghost" id="btnBackDash"><i class="fa-solid fa-gauge"></i> ‡∏Å‡∏•‡∏±‡∏ö‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</button>
      </div>
    </div>
  </div>
</div>

<script>
// ===== Configuration =====
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbyE8gS60fkUj4RTJ2uXT-PbV1eraIEHFPReNOvnWx5im3MLV8XHM7oXAYB_G_dXEIk/exec";

// ===== Helpers =====
const tz = 'Asia/Bangkok';
const $  = s => document.querySelector(s);
const byId = id => document.getElementById(id);
const setTextSafe = (id, t)=>{ const el=byId(id); if(el) el.textContent=t; };
const fmtTime = iso => !iso?'-': new Date(iso).toLocaleString('th-TH',{timeZone:tz,hour:'2-digit',minute:'2-digit',day:'2-digit',month:'short'});
const fmtDate = iso => !iso?'-': new Date(iso).toLocaleDateString('th-TH',{timeZone:tz});
const hearts = n => n>0 ? '‚ù§'.repeat(Math.max(1,Math.min(10,Math.round(n)))) : '‚Äî';
const safeNum = v => { const n = Number(String(v??'').replace(/,/g,'')); return isFinite(n)? n:null; };
function onReady(fn){ if(document.readyState!=='loading') fn(); else document.addEventListener('DOMContentLoaded', fn); }
setInterval(()=>{ setTextSafe('nowTH', new Date().toLocaleString('th-TH',{timeZone:tz})); },1000);

function setStatus(type,msg){
  const dot = byId('dot'); const st = byId('statusText'); if(!dot||!st) return;
  dot.classList.remove('ok','fail','load');
  dot.classList.add(type==='ok'?'ok':type==='fail'?'fail':'load');
  st.textContent = msg||'';
}
const COLS = {
  ts:['Timestamp (Asia/Bangkok)','Timestamp (Asia)','Timestamp','time','Time'],
  tC:['Temperature (¬∞C)','Temperature (¬∞C','AirTemp_C','Temp_C','Temp','Temperature'],
  rh:['Air Humidity (%)','Humid (%)','AirHumid_%RH','Humidity'],
  soil:['Soil Moisture (%)','Soil Moisture (%','SoilMoist_%','Soil'],
  light:['Light (%)','Light_%','Light'],
};
const SCORE = { score:['Score_1_10','Stars','Score'], ts:['Date','Timestamp'] };
const pick = (row, keys)=>{ for(const k of keys){ if(row && row[k]!=null && row[k]!=='' && row[k]!==undefined) return row[k]; } return null; };

const buildURL=(base,obj={})=>{ const u=new URL(base); Object.entries(obj).forEach(([k,v])=>u.searchParams.set(k,v)); return u.toString(); };
async function getJSON(url){
  const r = await fetch(url,{cache:'no-store',credentials:'omit',referrerPolicy:'no-referrer'});
  if(!r.ok) throw new Error('HTTP '+r.status);
  return r.json();
}
async function postJSON(url, payload){
  const r = await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
  return r.json().catch(()=>({}));
}

// ===== UI nav =====
onReady(()=>{
  byId('webapp').value = localStorage.getItem('gs_webapp') || WEBAPP_URL || '';
  byId('teamNameA').value = localStorage.getItem('gs_teamNameA') || '‡∏ó‡∏µ‡∏° A';
  byId('teamNameB').value = localStorage.getItem('gs_teamNameB') || '‡∏ó‡∏µ‡∏° B';
  setTextSafe('teamALabel', byId('teamNameA').value);
  setTextSafe('teamBLabel', byId('teamNameB').value);
  setTextSafe('teamANameDisplay', byId('teamNameA').value);
  setTextSafe('teamBNameDisplay', byId('teamNameB').value);

  ['webapp','teamNameA','teamNameB','limit','interval','demo'].forEach(id=>{
    const el=byId(id); if(!el) return;
    const key='gs_'+id; const v=localStorage.getItem(key); if(v!==null) el.value=v;
    el.addEventListener('change',e=>{
      localStorage.setItem(key, e.target.value);
      if(id==='teamNameA'){ setTextSafe('teamALabel', e.target.value); setTextSafe('teamANameDisplay', e.target.value); }
      if(id==='teamNameB'){ setTextSafe('teamBLabel', e.target.value); setTextSafe('teamBNameDisplay', e.target.value); }
    });
  });
});

// ===== Flow state =====
let ctx={urlA:'',urlB:'',limit:50,interval:20000,cache:{A:{},B:{}}};

// ===== Buttons =====
onReady(()=>{
  byId('btnTest').addEventListener('click', async ()=>{
    const base = (byId('webapp').value||'').trim();
    if(!base){ setStatus('fail','‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏™‡πà URL'); return; }
    try{ new URL(base); }catch(_){ setStatus('fail','URL ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'); return; }
    setStatus('load','‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‚Ä¶');
    try{
      const ping = await getJSON(buildURL(base,{action:'ping'}));
      setStatus(ping && ping.ok ? 'ok':'fail', ping.ok? ('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ ‚úî ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô: '+(ping.version||'-')) : '‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
    }catch(e){ setStatus('fail','‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: '+e.message); }
  });

  byId('btnStart').addEventListener('click', async ()=>{
    const base = (byId('webapp').value||'').trim();
    const demo = byId('demo').value==='on';
    const limit = Number(byId('limit').value||50);
    const interval = Number(byId('interval').value||20)*1000;

    let urlA, urlB;
    if(demo){ urlA='demo://A'; urlB='demo://B'; }
    else{
      if(!base){ setStatus('fail','‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà Web App URL ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏î‡∏™‡∏≠‡∏ö'); return; }
      try{ new URL(base); }catch(_){ setStatus('fail','URL ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'); return; }
      urlA=base; urlB=base;
    }

    localStorage.setItem('gs_webapp', base);
    localStorage.setItem('gs_teamNameA', byId('teamNameA').value);
    localStorage.setItem('gs_teamNameB', byId('teamNameB').value);
    localStorage.setItem('gs_limit', String(limit));
    localStorage.setItem('gs_interval', String(interval));
    localStorage.setItem('gs_demo', demo?'on':'off');

    ctx={urlA,urlB,limit,interval,cache:{A:{},B:{}}};
    try{
      byId('dsA').textContent = demo? 'DEMO' : (new URL(urlA)).host;
      byId('dsB').textContent = demo? 'DEMO' : (new URL(urlB)).host;
    }catch(_){}
    setStatus('ok','‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß - ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‚Ä¶');
    show('secDash');
    startDashboard();
  });

  byId('btnRefresh').addEventListener('click', ()=>{ setStatus('load','‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‚Ä¶'); tickOnce().finally(()=>setStatus('ok','‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡πÅ‡∏•‡πâ‡∏ß')); });
  byId('btnGoInsights').addEventListener('click', ()=>{ show('secInsights'); setTimeout(renderInsights, 300); });
  byId('btnBackDash').addEventListener('click', ()=> show('secDash'));
  byId('btnReset').addEventListener('click', resetAllSettings);

  byId('btnAnalyzeToday').addEventListener('click', async ()=>{
    setStatus('load','‡∏™‡∏±‡πà‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏î‡πâ‡∏ß‡∏¢ AI ‚Ä¶');
    const tasks=[];
    if(!ctx.urlA.startsWith('demo://')) tasks.push(fetch(buildURL(ctx.urlA,{action:'analyzenow',team:'A',for:'today'})));
    if(!ctx.urlB.startsWith('demo://')) tasks.push(fetch(buildURL(ctx.urlB,{action:'analyzenow',team:'B',for:'today'})));
    try{ await Promise.allSettled(tasks); await tickOnce(); renderInsights(); setStatus('ok','‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏•‡∏∞‡πÇ‡∏´‡∏•‡∏î‡∏ú‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); }
    catch(e){ setStatus('fail','‡∏™‡∏±‡πà‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); }
  });
});

function show(id){ ['secForm','secDash','secInsights'].forEach(x=>{ const el=byId(x); if(el) el.style.display=(x===id)?'block':'none'; }); }

function resetAllSettings(){
  if(!confirm('‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')) return;
  ['gs_webapp','gs_teamNameA','gs_teamNameB','gs_limit','gs_interval','gs_demo'].forEach(k=>localStorage.removeItem(k));
  location.reload();
}

// ===== Data fetchers =====
const buildPack = async (url, team, limit)=>{
  if(url.startsWith('demo://')){
    return { data: demoRows(), scoreAI: demoDailyAI() };
  }
  const dataUrl = buildURL(url,{action:'data',team,limit});
  const aiUrl   = buildURL(url,{action:'ai_daily',team,limit:30});
  const [dRes, aiRes] = await Promise.allSettled([ getJSON(dataUrl), getJSON(aiUrl) ]);
  return {
    data:  dRes.status==='fulfilled' ? (dRes.value.rows||[]) : [],
    scoreAI: aiRes.status==='fulfilled'? (aiRes.value.rows||[]) : []
  };
};

async function renderTeam(url, team, prefix){
  const pack = await buildPack(url, team, ctx.limit);
  ctx.cache[team] = pack;

  // latest live
  if(pack.data.length){
    const r = pack.data[0];
    setTextSafe(prefix+'temp',  safeNum(pick(r, COLS.tC)) ?? '-');
    setTextSafe(prefix+'hum',   safeNum(pick(r, COLS.rh)) ?? '-');
    setTextSafe(prefix+'soil',  safeNum(pick(r, COLS.soil)) ?? '-');
    setTextSafe(prefix+'light', safeNum(pick(r, COLS.light)) ?? '-');

    const tb = byId(prefix+'tbl');
    if(tb){
      tb.innerHTML='';
      pack.data.slice(0,10).forEach(row=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>${fmtTime(pick(row, COLS.ts))}</td>
          <td style="text-align:center">${pick(row, COLS.tC) ?? '-'}</td>
          <td style="text-align:center">${pick(row, COLS.rh) ?? '-'}</td>
          <td style="text-align:center">${pick(row, COLS.soil) ?? '-'}</td>
          <td style="text-align:center">${pick(row, COLS.light) ?? '-'}</td>`;
        tb.appendChild(tr);
      });
    }
  }else{
    ['temp','hum','soil','light'].forEach(k=> setTextSafe(prefix+k,'-'));
  }

  // AI daily score
  if(pack.scoreAI && pack.scoreAI.length){
    const top = pack.scoreAI[0];
    const sc = Number(top.Score_1_10 || top.Stars || 0);
    const ad = top.Advice || '-';
    setTextSafe(prefix+'hearts', hearts(sc));
    setTextSafe(prefix+'advice', `‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ (AI): ${ad}`);
  }else{
    setTextSafe(prefix+'hearts','‚Äî');
    setTextSafe(prefix+'advice','‚Äî');
  }
}

async function tickOnce(){ await Promise.all([ renderTeam(ctx.urlA,'A','a_'), renderTeam(ctx.urlB,'B','b_') ]); }
let timer=null;
async function startDashboard(){ await tickOnce(); if(timer) clearInterval(timer); timer=setInterval(()=>{ tickOnce().catch(console.error); }, ctx.interval||20000); }

// ===== Insights (use AI daily rows) =====
let heartChart=null;
function renderInsights(){
  const A=(ctx.cache.A.scoreAI||[]).slice(0,30).reverse();
  const B=(ctx.cache.B.scoreAI||[]).slice(0,30).reverse();
  const labels=(A.length?A:B).map(x=>x.Date || '');
  const dataA=A.map(x=>Number(x.Score_1_10||x.Stars||0));
  const dataB=B.map(x=>Number(x.Score_1_10||x.Stars||0));
  const canvas=byId('chartHearts'); if(!canvas) return;
  const c2=canvas.getContext('2d'); if(heartChart) heartChart.destroy();
  heartChart=new Chart(c2,{type:'line',data:{labels,datasets:[
    {label:byId('teamANameDisplay').textContent,data:dataA,tension:.25,pointRadius:2,borderWidth:2,borderColor:'#10b981',backgroundColor:'#10b98120',fill:false},
    {label:byId('teamBNameDisplay').textContent,data:dataB,tension:.25,pointRadius:2,borderWidth:2,borderColor:'#8b5cf6',backgroundColor:'#8b5cf620',fill:false}
  ]},options:{responsive:true,scales:{y:{suggestedMin:0,suggestedMax:10,ticks:{stepSize:1}}}}});

  const daily = avgAIBy_('day');
  const weekly= avgAIBy_('week');
  byId('dailyTable').innerHTML  = tableSummary(daily);
  byId('weeklyTable').innerHTML = tableSummary(weekly);
}
function avgAIBy_(kind){
  const coll = rows => (rows||[]).map(o=>{
    const d=o.Date || o.Timestamp; const key=(kind==='day')? d : weekKey(d);
    const s=Number(o.Score_1_10||o.Stars||0); return {d:key,s};
  });
  const A=coll(ctx.cache.A.scoreAI), B=coll(ctx.cache.B.scoreAI);
  const agg=ar=>ar.reduce((m,x)=>((m[x.d]=m[x.d]||[]).push(x.s),m),{});
  const avg=o=>Object.entries(o).map(([d,vs])=>({date:d,avg:+(vs.reduce((a,b)=>a+b,0)/vs.length).toFixed(2)}))
                      .sort((a,b)=>a.date.localeCompare(b.date));
  return {A:avg(agg(A)),B:avg(agg(B))};
}
function weekKey(iso){ if(!iso) return '-'; const d=new Date(iso); const y=d.getFullYear(); const first=new Date(y,0,1); const days=Math.floor((d-first)/86400000)+first.getDay()+1; const w=Math.floor(days/7); return `${y}-W${('0'+w).slice(-2)}`; }
function tableSummary(obj){
  const keys=Array.from(new Set([...(obj.A||[]).map(x=>x.date),...(obj.B||[]).map(x=>x.date)])).sort();
  if(!keys.length) return '<div class="muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
  let h=`<table><thead><tr><th style="text-align:left">‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤</th><th>${byId('teamANameDisplay').textContent}</th><th>${byId('teamBNameDisplay').textContent}</th></tr></thead><tbody>`;
  keys.forEach(k=>{
    const a=(obj.A||[]).find(x=>x.date===k)?.avg ?? '-';
    const b=(obj.B||[]).find(x=>x.date===k)?.avg ?? '-';
    h+=`<tr><td>${k}</td><td style="text-align:center">${a}</td><td style="text-align:center">${b}</td></tr>`;
  });
  h+='</tbody></table>'; return h;
}

// ===== Demo data (if demo mode) =====
function demoRows(){
  const now=Date.now();
  const mk=i=>({'Timestamp (Asia/Bangkok)':new Date(now - i*60000).toISOString(),'Temperature (¬∞C)': +(25+Math.sin(i/6)*2).toFixed(1),'Air Humidity (%)':55+((i*7)%10),'Soil Moisture (%)':40+((i*5)%20),'Light (%)':60+((i*3)%20)});
  return Array.from({length:50},(_,i)=>mk(i));
}
function demoDailyAI(){
  const today=new Date();
  const mk=i=>{const d=new Date(today.getTime()-i*86400000);const ds=d.toISOString().slice(0,10);const s=6+Math.round(Math.sin(i/2)*2);return {Date:ds,Score_1_10:s,Stars:s,Advice:'‡∏î‡∏π‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏î‡∏ô‡πâ‡∏≥-‡πÅ‡∏™‡∏á‡πÉ‡∏´‡πâ‡∏û‡∏≠‡∏î‡∏µ'};};
  return Array.from({length:14},(_,i)=>mk(i));
}

// ===== Self test & default
onReady(()=>{ console.log('AI Daily Dashboard loaded'); });
</script>
</body>
</html>

