<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>üåø GreenSync Duel ‚Äî Form ‚Üí Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Noto+Sans+Thai:wght@400;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  :root{
    --bg:#f5f7fa;--text:#1f2430;--muted:#667085;--card:#fff;--border:#e5e7eb;
    --primary:#10b981;--primary-light:#d1fae5;--primary-dark:#047857;
    --secondary:#8b5cf6;--accent:#f59e0b;
  }
  .theme-kid{--bg:#e0f7fa;--text:#01579b;--muted:#4dd0e1;--card:#fff;--border:#b2ebf2;--primary:#00bcd4;--primary-light:#b2ebf2;--primary-dark:#00838f;--secondary:#ff4081;--accent:#ffc107;}
  .theme-teen{--bg:#f3e5f5;--text:#4a148c;--muted:#8e24aa;--card:#fff;--border:#e1bee7;--primary:#9c27b0;--primary-light:#e1bee7;--primary-dark:#6a1b9a;--secondary:#ff9800;--accent:#4caf50;}
  .theme-adult{--bg:#f5f5f5;--text:#212121;--muted:#757575;--card:#fff;--border:#e0e0e0;--primary:#455a64;--primary-light:#cfd8dc;--primary-dark:#263238;--secondary:#607d8b;--accent:#ff5722;}
  .theme-cny{--bg:#fff9f9;--text:#b71c1c;--muted:#d32f2f;--card:#fff;--border:#ffcdd2;--primary:#d32f2f;--primary-light:#ffcdd2;--primary-dark:#b71c1c;--secondary:#ffc107;--accent:#4caf50;}
  .theme-valentine{--bg:#fff5f7;--text:#880e4f;--muted:#ad1457;--card:#fff;--border:#f8bbd9;--primary:#e91e63;--primary-light:#f8bbd9;--primary-dark:#ad1457;--secondary:#ec407a;--accent:#ab47bc;}
  .theme-newyear{--bg:#f0f8ff;--text:#0d47a1;--muted:#1565c0;--card:#fff;--border:#bbdefb;--primary:#0d47a1;--primary-light:#bbdefb;--primary-dark:#002171;--secondary:#ff6d00;--accent:#00c853;}

  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,"Noto Sans Thai",system-ui;transition:.3s}
  .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
  .h1{font-weight:700;font-size:28px}
  .muted{color:var(--muted)}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 6px 18px rgba(0,0,0,.06);margin-bottom:16px;transition:.3s}
  .hd{padding:14px 16px;border-bottom:1px solid var(--border);font-weight:600;background:var(--primary-light);color:var(--primary-dark)}
  .bd{padding:14px 16px}
  label{display:block;margin-bottom:6px;font-size:14px}
  input,select{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;transition:.2s}
  input:focus,select:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px var(--primary-light)}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .btn{display:inline-flex;gap:8px;align-items:center;border-radius:999px;padding:10px 16px;border:1px solid var(--primary);background:var(--primary);color:#fff;cursor:pointer;font-weight:600;transition:.2s}
  .btn:hover{background:var(--primary-dark);transform:translateY(-2px);box-shadow:0 4px 8px rgba(0,0,0,.1)}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  @media(max-width:900px){.row{grid-template-columns:1fr}.grid2{grid-template-columns:1fr}}
  .kpi{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:8px}
  .kpi .it{background:#f8fafc;border:1px solid var(--border);border-radius:12px;padding:8px 10px}
  .kpi .v{font-weight:700}
  .hearts{font-size:28px;line-height:1.1;color:#e91e63}
  table{width:100%;border-collapse:collapse}
  th,td{padding:6px 8px;border-bottom:1px solid var(--border);font-size:13px}
  thead th{background:#f8fafc}
  .flex{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;background:var(--primary-light);color:var(--primary-dark);font-weight:600;font-size:12px}
  .err{color:#b91c1c;font-weight:600}
  .ok{color:#047857;font-weight:600}
</style>
</head>
<body>
<div class="wrap">
  <!-- Header -->
  <div class="card">
    <div class="bd flex" style="justify-content:space-between">
      <div>
        <div class="h1">üåø GreenSync ‚Äî Duel Mode</div>
        <div class="muted">‡∏Å‡∏£‡∏≠‡∏Å‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå ‚Üí ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô ‚Üí ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î 2 ‡∏Å‡∏£‡∏∞‡∏ñ‡∏≤‡∏á ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡∏´‡∏±‡∏ß‡πÉ‡∏à</div>
      </div>
      <div class="flex">
        <select id="theme" title="‡∏ò‡∏µ‡∏°">
          <option value="default">‡∏ò‡∏µ‡∏°‡∏õ‡∏Å‡∏ï‡∏¥</option>
          <option value="kid">‡∏ò‡∏µ‡∏°‡πÄ‡∏î‡πá‡∏Å</option>
          <option value="teen">‡∏ò‡∏µ‡∏°‡∏ß‡∏±‡∏¢‡∏£‡∏∏‡πà‡∏ô</option>
          <option value="adult">‡∏ò‡∏µ‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏´‡∏ç‡πà</option>
          <option value="cny">‡∏ò‡∏µ‡∏°‡∏ï‡∏£‡∏∏‡∏©‡∏à‡∏µ‡∏ô</option>
          <option value="valentine">‡∏ò‡∏µ‡∏°‡∏ß‡∏≤‡πÄ‡∏•‡∏ô‡πÑ‡∏ó‡∏ô‡πå</option>
          <option value="newyear">‡∏ò‡∏µ‡∏°‡∏õ‡∏µ‡πÉ‡∏´‡∏°‡πà</option>
        </select>
        <span class="badge"><i class="fa-solid fa-clock"></i> <span id="nowTH">‚Äî</span></span>
      </div>
    </div>
  </div>

  <!-- FORM -->
  <div class="card" id="secForm">
    <div class="hd">‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå & ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</div>
    <div class="bd">
      <div class="row">
        <div>
          <label>Web App URL (‡∏£‡∏ß‡∏°‡∏ó‡∏µ‡∏° A/B) ‚Äî ‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢ /exec</label>
          <input id="webapp" placeholder="https://script.google.com/macros/s/DEPLOYMENT_ID/exec">
        </div>
        <div>
          <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ñ‡∏ß (limit)</label>
          <select id="limit"><option>10</option><option>30</option><option selected>50</option><option>100</option></select>
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <div>
          <label>‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î Web App ‡πÅ‡∏¢‡∏Å‡∏ó‡∏µ‡∏° (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö) ‚Äî ‡∏ó‡∏µ‡∏° A</label>
          <input id="webappA" placeholder="‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ ‡∏ñ‡πâ‡∏≤‡πÉ‡∏ä‡πâ URL ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô">
        </div>
        <div>
          <label>‡∏ó‡∏µ‡∏° B</label>
          <input id="webappB" placeholder="‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ ‡∏ñ‡πâ‡∏≤‡πÉ‡∏ä‡πâ URL ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô">
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <div>
          <label>‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå‡∏ï‡πâ‡∏ô‡πÑ‡∏°‡πâ</label>
          <input id="plant" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏¢‡∏≤‡∏á‡∏≠‡∏¥‡∏ô‡πÄ‡∏î‡∏µ‡∏¢ / ‡∏°‡∏≠‡∏ô‡∏™‡πÄ‡∏ï‡∏≠‡∏£‡πà‡∏≤">
        </div>
        <div>
          <label>‡∏Ç‡∏ô‡∏≤‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏•‡∏π‡∏Å</label>
          <input id="size" placeholder="‡πÄ‡∏ä‡πà‡∏ô 2 x 3 ‡πÄ‡∏°‡∏ï‡∏£">
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <div>
          <label>‡πÅ‡∏™‡∏á</label>
          <select id="lightCond"><option>‡∏û‡∏≠‡∏°‡∏≤‡∏Å</option><option selected>‡∏û‡∏≠‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</option><option>‡∏ô‡πâ‡∏≠‡∏¢/‡∏≠‡∏±‡∏ö‡πÅ‡∏™‡∏á</option></select>
        </div>
        <div>
          <label>‡∏Å‡∏≤‡∏£‡∏ñ‡πà‡∏≤‡∏¢‡πÄ‡∏ó‡∏≠‡∏≤‡∏Å‡∏≤‡∏®</label>
          <select id="airflow"><option>‡πÇ‡∏õ‡∏£‡πà‡∏á</option><option selected>‡∏û‡∏≠‡πÉ‡∏ä‡πâ</option><option>‡∏≠‡∏±‡∏ö</option></select>
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <div>
          <label>‡πÅ‡∏≠‡∏£‡πå</label>
          <select id="ac"><option>‡∏ï‡∏•‡∏≠‡∏î‡∏ß‡∏±‡∏ô</option><option selected>‡∏ö‡∏≤‡∏á‡πÄ‡∏ß‡∏•‡∏≤</option><option>‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î</option></select>
        </div>
        <div>
          <label>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡∏•‡∏π‡∏Å (‡πÉ‡∏ä‡πâ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏£‡πà‡∏ß‡∏° A/B)</label>
          <input id="name" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡∏£‡∏π‡∏£‡∏±‡∏ä‡∏û‡∏•">
        </div>
      </div>

      <div style="margin-top:12px" class="flex">
        <button class="btn" id="btnStart"><i class="fa-solid fa-play"></i> ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô ‚ûú ‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</button>
        <span id="status" class="muted"></span>
      </div>
    </div>
  </div>

  <!-- DASHBOARD -->
  <div class="card" id="secDash" style="display:none">
    <div class="hd">‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î 2 ‡∏Å‡∏£‡∏∞‡∏ñ‡∏≤‡∏á (‡∏ó‡∏µ‡∏° A vs ‡∏ó‡∏µ‡∏° B)</div>
    <div class="bd grid2">
      <!-- LEFT -->
      <div>
        <div class="flex" style="justify-content:space-between">
          <div class="muted">‡∏ó‡∏µ‡∏° A</div>
          <div class="badge"><i class="fa-solid fa-database"></i> <span id="dsA">‚Äî</span></div>
        </div>
        <div class="kpi" style="margin-top:8px">
          <div class="it"><div>Temp (¬∞C)</div><div class="v" id="a_temp">-</div></div>
          <div class="it"><div>Humid (%)</div><div class="v" id="a_hum">-</div></div>
          <div class="it"><div>Soil (%)</div><div class="v" id="a_soil">-</div></div>
          <div class="it"><div>Light (%)</div><div class="v" id="a_light">-</div></div>
        </div>
        <div style="margin-top:8px">‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ:</div>
        <div class="hearts" id="a_hearts">‚Äî</div>
        <div class="muted" id="a_advice" style="margin-top:6px">‚Äî</div>
        <table style="margin-top:10px">
          <thead><tr><th style="text-align:left">‡πÄ‡∏ß‡∏•‡∏≤</th><th>Temp</th><th>RH</th><th>Soil</th><th>Light</th></tr></thead>
          <tbody id="a_tbl"></tbody>
        </table>
      </div>

      <!-- RIGHT -->
      <div>
        <div class="flex" style="justify-content:space-between">
          <div class="muted">‡∏ó‡∏µ‡∏° B</div>
          <div class="badge"><i class="fa-solid fa-database"></i> <span id="dsB">‚Äî</span></div>
        </div>
        <div class="kpi" style="margin-top:8px">
          <div class="it"><div>Temp (¬∞C)</div><div class="v" id="b_temp">-</div></div>
          <div class="it"><div>Humid (%)</div><div class="v" id="b_hum">-</div></div>
          <div class="it"><div>Soil (%)</div><div class="v" id="b_soil">-</div></div>
          <div class="it"><div>Light (%)</div><div class="v" id="b_light">-</div></div>
        </div>
        <div style="margin-top:8px">‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ:</div>
        <div class="hearts" id="b_hearts">‚Äî</div>
        <div class="muted" id="b_advice" style="margin-top:6px">‚Äî</div>
        <table style="margin-top:10px">
          <thead><tr><th style="text-align:left">‡πÄ‡∏ß‡∏•‡∏≤</th><th>Temp</th><th>RH</th><th>Soil</th><th>Light</th></tr></thead>
          <tbody id="b_tbl"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
const $  = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);

// ===== Utilities =====
const tz = 'Asia/Bangkok';
const fmtDashTime = iso => {
  if(!iso) return '-';
  const d = new Date(iso);
  return d.toLocaleString('th-TH',{ timeZone: tz, hour:'2-digit', minute:'2-digit', day:'2-digit', month:'short' });
};
const safeNum = (v) => {
  const n = Number(String(v).replace(/,/g,''));
  return isFinite(n) ? n : null;
};
const getFirst = (obj, keys) => {
  for(const k of keys){ if(obj && obj[k]!=null && obj[k]!=='' ) return obj[k]; }
  return null;
};
const hearts = score => {
  if(score==null) return '‚Äî';
  const s = Math.max(0, Math.min(10, Math.round(score)));
  return s>0 ? '‚ù§'.repeat(s) : '‚Äî';
};
const uiStatus = (msg, ok=false) => {
  const el = $('#status');
  el.className = ok ? 'ok' : 'err';
  el.textContent = msg;
};

// live clock
const tick = () => { $('#nowTH').textContent = new Date().toLocaleString('th-TH',{ timeZone: tz }); };
tick(); setInterval(tick, 1000);

// theme
const applyTheme = (val) => {
  document.body.classList.remove('theme-kid','theme-teen','theme-adult','theme-cny','theme-valentine','theme-newyear');
  if(val && val!=='default') document.body.classList.add('theme-'+val);
  localStorage.setItem('theme', val||'default');
};
$('#theme').value = localStorage.getItem('theme') || 'default';
applyTheme($('#theme').value);
$('#theme').addEventListener('change', e => applyTheme(e.target.value));

// persist form
['webapp','webappA','webappB','limit','plant','size','lightCond','airflow','ac','name'].forEach(id=>{
  const v = localStorage.getItem('gs_'+id);
  if(v!==null) $('#'+id).value = v;
  $('#'+id).addEventListener('change', e=> localStorage.setItem('gs_'+id, e.target.value));
});

// ===== Data adapters (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏´‡∏•‡∏≤‡∏¢ schema) =====
const COLS = {
  ts: ['Timestamp (Asia/Bangkok)','Timestamp','time','Time'],
  tC: ['AirTemp_C','Temperature (¬∞C)','Temp_C','Temp','Temperature'],
  rh: ['AirHumid_%RH','Humid (%)','Humidity (%)','Humidity','AirHumidity'],
  soil: ['SoilMoist_%','Soil Moisture (%)','Soil_%','Soil','SoilMoisture'],
  light: ['Light_%','Light (%)','Lux_%','Light'],
};
const SCORE = {
  score: ['Score_1_10','Score','Score_0_5','Score1_10'],
  advice: ['Advice','AI_Advice','Note','Tips']
};
function pickRowValue(row, list){ return getFirst(row, list); }

// ===== Backend URLs =====
const buildURL = (base, params={}) => {
  const u = new URL(base);
  Object.entries(params).forEach(([k,v])=>u.searchParams.set(k,v));
  return u.toString();
};

// ===== Fetchers =====
async function postJSON(url, payload){
  const res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
  if(!res.ok) throw new Error('HTTP '+res.status);
  return res.json().catch(()=> ({}));
}
async function getJSON(url){
  const res = await fetch(url);
  if(!res.ok) throw new Error('HTTP '+res.status);
  return res.json();
}

// ===== Main flow =====
$('#btnStart').addEventListener('click', async ()=>{
  const base = $('#webapp').value.trim();
  const baseA = $('#webappA').value.trim();
  const baseB = $('#webappB').value.trim();
  if(!base && !(baseA && baseB)){
    uiStatus('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà Web App URL (‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡∏ä‡πà‡∏≠‡∏á‡∏ö‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏¢‡∏Å‡∏ó‡∏µ‡∏° A/B)', false);
    return;
  }
  const urlA = baseA || base;
  const urlB = baseB || base;

  // Validate URL format
  try{ new URL(urlA); new URL(urlB); }catch(e){ uiStatus('URL ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢‡∏î‡πâ‡∏ß‡∏¢ /exec', false); return; }

  // Save profile A/B (‡πÄ‡∏á‡∏µ‡∏¢‡∏ö‡πÜ)
  const pf = {
    action:"saveProfile",
    name: $('#name').value.trim(),
    plant: $('#plant').value.trim(),
    size: $('#size').value.trim(),
    light: $('#lightCond').value,
    airflow: $('#airflow').value,
    ac: $('#ac').value
  };

  $('#status').className='muted'; $('#status').textContent='‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡∏° A/B...';
  try{
    await Promise.allSettled([
      postJSON(urlA, {...pf, team:'A'}),
      postJSON(urlB, {...pf, team:'B'})
    ]);
    $('#status').className='ok'; $('#status').textContent='‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß ‚Ä¢ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‚Ä¶';
  }catch(e){
    uiStatus('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ‡πÅ‡∏ï‡πà‡∏à‡∏∞‡∏•‡∏≠‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡πà‡∏≠ (‡πÄ‡∏ä‡πá‡∏Ñ CORS/Deployment)', false);
  }

  // show dash
  $('#secForm').style.display='none';
  $('#secDash').style.display='block';
  $('#dsA').textContent = (new URL(urlA)).host;
  $('#dsB').textContent = (new URL(urlB)).host;

  startDashboard({urlA, urlB, limit: Number($('#limit').value || 50)});
});

async function startDashboard({urlA, urlB, limit}){
  async function fetchPack(url, team){
    // data
    const dataUrl = buildURL(url, {action:'data', team, limit});
    // analyze now (non-blocking)
    const anaUrl  = buildURL(url, {action:'analyzeNow', team});
    // score
    const scoreUrl= buildURL(url, {action:'score', team});

    const [dataRes, _ana, scoreRes] = await Promise.allSettled([
      getJSON(dataUrl),
      fetch(anaUrl).catch(()=>{}),
      getJSON(scoreUrl)
    ]);

    const rows   = (dataRes.status==='fulfilled' && dataRes.value && dataRes.value.rows) ? dataRes.value.rows : [];
    const scores = (scoreRes.status==='fulfilled' && scoreRes.value && scoreRes.value.rows) ? scoreRes.value.rows : [];
    return {rows, scores};
  }

  async function render(url, team, prefix){
    try{
      const {rows, scores} = await fetchPack(url, team);

      // KPI last row
      if(rows.length){
        const r0 = rows[0];
        const tC   = safeNum(pickRowValue(r0, COLS.tC));
        const rh   = safeNum(pickRowValue(r0, COLS.rh));
        const soil = safeNum(pickRowValue(r0, COLS.soil));
        const li   = safeNum(pickRowValue(r0, COLS.light));

        $('#'+prefix+'temp').textContent  = tC!=null   ? tC.toFixed(1) : '-';
        $('#'+prefix+'hum').textContent   = rh!=null   ? rh           : '-';
        $('#'+prefix+'soil').textContent  = soil!=null ? soil         : '-';
        $('#'+prefix+'light').textContent = li!=null   ? li           : '-';

        const tb = $('#'+prefix+'tbl'); tb.innerHTML='';
        rows.slice(0, limit).forEach(o=>{
          const ts   = pickRowValue(o, COLS.ts);
          const tC_  = pickRowValue(o, COLS.tC);
          const rh_  = pickRowValue(o, COLS.rh);
          const soil_= pickRowValue(o, COLS.soil);
          const li_  = pickRowValue(o, COLS.light);
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${fmtDashTime(ts)}</td>
            <td style="text-align:center">${tC_ ?? '-'}</td>
            <td style="text-align:center">${rh_ ?? '-'}</td>
            <td style="text-align:center">${soil_ ?? '-'}</td>
            <td style="text-align:center">${li_ ?? '-'}</td>`;
          tb.appendChild(tr);
        });
      }

      // Score & advice
      if(scores.length){
        const sRow  = scores[0];
        let score = safeNum(pickRowValue(sRow, SCORE.score));
        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏™‡πÄ‡∏Å‡∏• 0‚Äì5 ‡πÉ‡∏´‡πâ‡∏Ñ‡∏π‡∏ì‡∏™‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏°‡πá‡∏û‡∏´‡∏±‡∏ß‡πÉ‡∏à 1‚Äì10
        if(score!=null && score<=5) score = score*2;
        const adv   = pickRowValue(sRow, SCORE.advice);
        $('#'+prefix+'hearts').textContent = hearts(score);
        $('#'+prefix+'advice').textContent = adv ? ('‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: '+adv) : '‚Äî';
      }else{
        $('#'+prefix+'hearts').textContent = '‚Äî';
        $('#'+prefix+'advice').textContent = '‚Äî';
      }
    }catch(e){
      $('#'+prefix+'hearts').textContent = '‚Äî';
      $('#'+prefix+'advice').textContent = '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‚Ä¢ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Web App/‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á';
    }
  }

  const cycle = async ()=>{
    await Promise.all([
      render(urlA, 'A', 'a_'),
      render(urlB, 'B', 'b_')
    ]);
  };
  await cycle();
  setInterval(cycle, 20000);
}
</script>
</body>
</html>
